<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Dual.Infodose v8.1 ¬∑ KOBLLUX OMEGA</title>
  <meta name="theme-color" content="#050811" />
  <meta name="description" content="KODUX INTEGRATED [ATLAS + V.E.E.B] - Interface Neural">

  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap">
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.10.0/build/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.10.0/styles/github-dark.min.css">
  
  <script>
    // Highlight init
    document.addEventListener('DOMContentLoaded', () => hljs.highlightAll());
    // SW Register
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }
  </script>

  <style>
    /* =========================================
       1. SOLAR NEBULA PRO ‚Äî CORE CSS (V8.0 Refined)
       ========================================= */
    :root {
      --bg-deep: #050811; 
      --bg-day: radial-gradient(circle at 30% 20%, #ffffff 0%, #f2f8ff 18%, #d0e9ff 40%, #9ed0ff 65%, #6bb9ff 85%, #59a8ff 100%);
      --bg-sunset: linear-gradient(180deg, #fbcfe8 0%, #fb923c 20%, #4c1d95 60%, #111827 100%);
      --bg-night: radial-gradient(circle at 20% 0%, #0b1020 0%, #121c3b 40%, #1a237e 80%, #000000 100%);
      --bg-panel: rgba(10, 14, 24, 0.95);
      --primary: #00f5ff;
      --secondary: #ff4bff;
      --text-main: #e4ecff;
      --text-muted: #9aa4c8;
      --danger: #ff4b6b;
      --glass: blur(20px) saturate(180%);
      
      /* Beauty Vars */
      --txt-card: color-mix(in oklab, var(--panel, #0e1220) 92%, black);
      --txt-bd: color-mix(in oklab, var(--text-main) 16%, transparent);
      --chip-bg: linear-gradient(42deg, var(--primary), var(--secondary));
      --chip-ink: #000;
      
      /* List Vars */
      --list-bg: color-mix(in oklab, var(--bg-deep) 90%, black);
      --list-radius: 16px;
    }

    /* Reset & Base */
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg-deep); color: var(--text-main); font-family: "Montserrat", sans-serif; overflow: hidden; transition: background 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
    
    /* Modos Solares */
    body.mode-day { background: var(--bg-day) !important; color: #1a1a1a !important; --txt-bd: rgba(0,0,0,0.1); --list-bg: rgba(255,255,255,0.8); --txt-card: #fff; }
    body.mode-sunset { background: var(--bg-sunset) !important; color: #fff !important; }
    body.mode-night { background: var(--bg-night) !important; color: var(--text-main) !important; }

    /* Adapta√ß√£o UI Day */
    body.mode-day .msg-block.ai { background: rgba(255,255,255,0.7); color: #222; border-color: rgba(0,0,0,0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    body.mode-day .glass-input { background: rgba(255,255,255,0.8); color: #000; border-color: #ccc; }
    body.mode-day .btn-icon { color: #333; border-color: rgba(0,0,0,0.2); }
    body.mode-day .cockpit-item, body.mode-day .deck-item { background: rgba(255,255,255,0.5); color: #000; }
    body.mode-day .drawer-content { background: #f5f5f5; color: #222; }
    body.mode-day .cockpit-input { color: #000; border-bottom-color: rgba(0,0,0,0.2); }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    /* Fundo */
    .sky-layer { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    .sun-background { position: absolute; width: 300px; height: 300px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #fffde7 0%, #fff176 40%, #ffb300 100%); filter: blur(60px); opacity: 0; transition: opacity 2s; animation: sun-orbit 60s linear infinite; }
    body.mode-day .sun-background { opacity: 0.5; }
    @keyframes sun-orbit { 0% { transform: translate(-20vw, 10vh); } 50% { transform: translate(80vw, -10vh); } 100% { transform: translate(-20vw, 10vh); } }
    #particles-js { position: fixed; inset: 0; z-index: 1; opacity: 0.3; pointer-events: none; }
    body.mode-day #particles-js { opacity: 0.1; }
    #bg-fake-custom { position: fixed; inset: 0; z-index: 2; opacity: 0.2; background-size: cover; background-position: center; pointer-events: none; }

    /* Header Orb */
    .header-orb { position: fixed; top: 40px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; z-index: 15; animation: floatOrb 6s ease-in-out infinite; cursor: pointer; transition: all 0.5s ease; }
    .header-orb svg { width: 100%; height: 100%; transition: fill 0.5s ease; filter: drop-shadow(0 0 10px rgba(0,245,255,0.5)); }
    body.mode-day .header-orb svg { fill: #fff176; filter: drop-shadow(0 0 20px #ffb300); }
    body.mode-sunset .header-orb svg { fill: #ffb74d; filter: drop-shadow(0 0 30px #e65100); }
    body.mode-night .header-orb svg { fill: white; filter: drop-shadow(0 0 15px var(--primary)); }
    @keyframes floatOrb { 0%,100%{transform:translate(-50%,0)} 50%{transform:translate(-50%,-8px)} }
    
    #usernameDisplay { position: fixed; top: 120px; left: 50%; transform: translateX(-50%); z-index: 10; font-size: 0.75rem; color: var(--text-muted); opacity: 0.6; pointer-events: none; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    body.mode-day #usernameDisplay { color: #555; text-shadow: none; }

    #nv-toast { position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%) translateY(20px); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 50px; backdrop-filter: blur(10px); opacity: 0; transition: 0.4s; z-index: 9999; font-size: 0.8rem; pointer-events: none; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    #nv-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    #modeIndicator { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); font-size: 0.65rem; font-weight: bold; opacity: 0.5; z-index: 20; text-transform: uppercase; letter-spacing: 1px; color: var(--text-main); }
    body.mode-day #modeIndicator { color: #000; }

    /* Chat Area */
    .top-bar { position: fixed; top: 0; left: 0; right: 0; padding: 15px; display: flex; justify-content: space-between; z-index: 20; pointer-events: none; }
    .top-grp { display: flex; gap: 10px; pointer-events: auto; }
    
    #chat-container { position: absolute; top: 0; left: 50%; transform: translateX(-50%); bottom: 0; padding: 140px 16px 140px 16px; z-index: 5; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; transition: opacity 0.4s ease; scroll-behavior: smooth; max-width: 980px; width: calc(100% - 10px); }
    #chat-container.collapsed { opacity: 0; pointer-events: none; }

    /* Scrollbar */
    #chat-container::-webkit-scrollbar { width: 6px; }
    #chat-container::-webkit-scrollbar-track { background: transparent; }
    #chat-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    body.mode-day #chat-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); }

    .msg-block { max-width: 85%; padding: 12px 16px; border-radius: 12px; position: relative; animation: slideIn 0.3s ease-out; line-height: 1.6; font-size: 0.95rem; word-wrap: break-word; display: block; }
    .msg-block.user { align-self: flex-end; margin-left: auto; margin-right: 0; background: rgba(0,245,255,0.08); border-right: 2px solid var(--primary); text-align: right; border-radius: 12px 12px 2px 12px; }
    .msg-block.ai { align-self: flex-start; margin-right: auto; margin-left: 0; background: rgba(255,255,255,0.05); border-left: 2px solid var(--secondary); border-radius: 12px 12px 12px 2px; }
    .msg-block.system { align-self: center; margin-left: auto; margin-right: auto; font-size: 0.75rem; opacity: 0.9; text-align: center; border: 1px dashed rgba(255,255,255,0.2); background: transparent; padding: 6px 12px; font-style: italic; max-width: 95%; }
    body.mode-day .msg-block.system { color: #555; border-color: rgba(0,0,0,0.2); }
    
    @keyframes slideIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

    /* Code & Preview */
    pre { position: relative; background: rgba(0,0,0,0.4); border-radius: 8px; margin: 10px 0; overflow-x: auto; border: 1px solid rgba(255,255,255,0.1); }
    code { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }
    .copy-code-btn { position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: var(--primary); font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; cursor: pointer; z-index: 10; opacity: 0.7; transition: 0.2s; }
    .copy-code-btn:hover { opacity: 1; background: var(--primary); color: #000; }

    /* VISUALIZADOR HTML */
    .html-viewer { margin-top: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden; background: #000; display: flex; flex-direction: column; }
    .html-viewer-bar { display: flex; background: rgba(255,255,255,0.1); padding: 8px; gap: 8px; position: sticky; top: 0; z-index: 10; }
    .html-viewer-btn { background: transparent; border: none; color: var(--text-muted); padding: 6px 12px; font-size: 0.75rem; cursor: pointer; border-radius: 4px; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
    .html-viewer-btn.active { background: var(--primary); color: #000; font-weight: bold; }
    .html-viewer-btn:hover:not(.active) { background: rgba(255,255,255,0.1); color: #fff; }
    .html-viewer-content { position: relative; width: 100%; height: 450px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; }
    .html-viewer-content iframe { width: 100%; height: 100%; border: none; background: white; }
    .html-viewer-code { display: none; width: 100%; height: 100%; overflow: auto; background: #1e1e1e; padding: 10px; }
    .html-viewer.show-code .html-viewer-content iframe { display: none; }
    .html-viewer.show-code .html-viewer-code { display: block; }
    .html-viewer.fullscreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; z-index: 9999; background: #000; border-radius: 0; }
    .html-viewer.fullscreen .html-viewer-content { height: calc(100vh - 48px); border: none; border-radius: 0; }
    
    /* Mensagens de Arquivo */
    .file-msg { border-left: 3px solid var(--secondary) !important; background: rgba(255,255,255,0.05); }
    .file-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.8rem; font-weight: bold; }
    .file-meta { font-size: 0.7rem; color: var(--text-muted); }
    
    .msg-tools { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; margin-top: 8px; opacity: 0.6; transition: 0.2s; }
    .msg-block:hover .msg-tools { opacity: 1; }
    .msg-block.ai .msg-tools { justify-content: flex-start; }
    .tool-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: inherit; padding: 4px 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; }
    .tool-btn:hover { background: var(--primary); color: #000; border-color: var(--primary); }
    .tool-btn svg { width: 14px; height: 14px; stroke: currentColor; stroke-width: 2; fill: none; }

    /* Input Dock */
    .input-dock { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); padding: 16px; background: linear-gradient(to top, var(--bg-deep) 40%, transparent); z-index: 30; display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 980px; border-radius: 16px 16px 0 0; }
    body.mode-day .input-dock { background: linear-gradient(to top, #f2f8ff 40%, transparent); }
    
    #filePreview { display: none; width: 100%; max-width: 400px; background: rgba(0,0,0,0.8); border: 1px solid var(--primary); border-radius: 12px; padding: 10px; margin-bottom: 10px; align-items: center; justify-content: space-between; backdrop-filter: blur(10px); }
    #filePreview.active { display: flex; animation: slideIn 0.3s; }
    .file-info { font-size: 0.8rem; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
    .file-actions { display: flex; gap: 10px; }
    .btn-preview { background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.7rem; }
    .btn-preview.primary { background: var(--primary); color: #000; }
    
    #field-toggle-handle { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.8rem; opacity: 0.9; cursor: pointer; padding-bottom: 12px; text-transform: lowercase; letter-spacing: 1px; transition: 0.3s; }
    #field-toggle-handle:hover { color: var(--primary); transform: scale(1.02); }
    .footer-dot{ width:8px; height:8px; border-radius:50%; background:var(--secondary); animation:pulse 2s infinite; }
    @keyframes pulse{50%{opacity:.4; box-shadow: 0 0 10px currentColor;}}
    
    .input-row { display: flex; width: 100%; gap: 8px; align-items: center; max-width: 800px; position: relative; }
    .glass-input { flex: 1; background: rgba(255,255,255,0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15); color: inherit; padding: 12px 20px; border-radius: 24px; outline: none; transition: 0.3s; font-size: 1rem; }
    .glass-input:focus { background: rgba(0,0,0,0.5); border-color: var(--primary); box-shadow: 0 0 15px rgba(0,245,255,0.2); }
    body.mode-day .glass-input:focus { background: white; }
    
    .btn-icon { width: 42px; height: 42px; min-width: 42px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: inherit; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; backdrop-filter: blur(5px); }
    .btn-icon:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); border-color: var(--primary); }
    .btn-icon svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
    .btn-primary { background: var(--primary); color: #000 !important; border: none; box-shadow: 0 0 10px rgba(0, 245, 255, 0.4); }
    #btnVoice.listening { background: var(--danger); box-shadow: 0 0 15px var(--danger); animation: pulse 1s infinite; color: white !important; border: none; }

    /* Drawers */
    .drawer { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s; display: flex; align-items: center; justify-content: center; }
    .drawer.open { opacity: 1; pointer-events: auto; }
    .drawer-content { width: 90%; max-width: 450px; max-height: 85vh; background: var(--bg-panel); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .drawer.open .drawer-content { transform: scale(1); }
    .drawer-header { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); }
    .drawer-header h3 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
    .drawer-body { padding: 20px; overflow-y: auto; flex: 1; }
    
    /* Cockpit */
    .cockpit-grid { display: flex; flex-direction: column; gap: 15px; }
    .cockpit-item { background: rgba(255,255,255,0.03); padding: 10px 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; }
    .cockpit-label { font-size: 0.7rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .cockpit-input { background: transparent; border: none; color: white; font-family: 'JetBrains Mono', monospace; font-size: 1rem; outline: none; width: 100%; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 5px; transition: 0.3s; }
    .cockpit-input:focus { border-bottom-color: var(--secondary); }
    .control-row { display: flex; gap: 10px; margin-top: 20px; }
    .btn-block { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: inherit; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 5px; }
    .btn-block:hover { background: rgba(255,255,255,0.15); border-color: var(--primary); }
    
    /* Deck Items */
    .deck-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
    .deck-info { cursor: pointer; flex: 1; }
    .deck-info h4 { margin: 0 0 5px 0; font-size: 0.9rem; }
    .deck-info span { font-size: 0.7rem; opacity: 0.7; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 0.8rem; color: var(--text-muted); }
    .glass-textarea { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); color: inherit; padding: 10px; border-radius: 8px; min-height: 80px; resize: vertical; }

    /* =========================================
       2. BEAUTY PATCH V3 + LIST V2 CSS
       ========================================= */
    .flow-text p { text-wrap: pretty; line-height: 1.65; letter-spacing: .01em; margin: .65rem 0; hyphens: auto; }
    .flow-text .kv-head { font-weight: 800; letter-spacing:.02em; margin: 1.2rem 0 .4rem; }
    
    .span-paren { padding: .05rem .35rem; border-radius: .55rem; border: 1px solid var(--txt-bd); color: color-mix(in oklab, var(--text-main) 92%, white); background: color-mix(in oklab, var(--txt-card) 86%, transparent); }
    .chip, .chip-btn { display:inline-grid; place-items:center; padding:.25rem .6rem; border-radius:999px; background: var(--chip-bg); color: var(--chip-ink); font-weight: 700; letter-spacing:.02em; box-shadow: 0 2px 10px rgba(0,0,0,.35); cursor: pointer; user-select: none; font-size: 0.8rem; }
    .chip + .chip { margin-left:.35rem; }

    .q-card { background: var(--txt-card); border: 1px solid var(--txt-bd); box-shadow: var(--txt-shadow, 0 6px 24px rgba(0,0,0,.25)); border-radius: 14px; padding: .85rem 1rem; margin: .9rem 0; display:grid; grid-template-columns:auto 1fr; gap:.65rem; align-items:start; }
    .q-card .q-ico { inline-size:1.65rem; block-size:1.65rem; border-radius:50%; display:grid; place-items:center; font-weight:800; color:#000; background: var(--chip-bg); }
    
    .list-card { background: var(--list-bg); border-radius: var(--list-radius); box-shadow: 0 6px 24px rgba(0,0,0,.25), inset 0 0 0 1px var(--txt-bd); border: 1px solid var(--txt-bd); padding: clamp(.6rem,.9rem,1rem); margin: .85rem 0; position:relative; }
    .list-card .copy-badge { position:absolute; top:.35rem; right:.35rem; font-size:.8rem; padding:.2rem .45rem; border-radius:999px; background: color-mix(in oklab, #fff 12%, var(--txt-card)); border: 1px solid var(--txt-bd); color: var(--text-main); opacity:.65; transition:.2s; user-select:none; cursor: pointer; }
    .list-card:hover .copy-badge { opacity:1; }
    .list-card ul, .list-card ol { margin:.25rem 0; padding:0; list-style:none; }
    .list-card li { display:grid; grid-template-columns:auto 1fr; gap:.65rem; align-items:start; padding:.35rem .25rem; }

    .list-card ol.ol-neo { counter-reset:item; }
    .list-card ol.ol-neo li { counter-increment:item; }
    .list-card ol.ol-neo li::before { content:counters(item, "."); inline-size:auto; min-inline-size: 1.65rem; block-size: 1.65rem; padding:0 .55rem; display:grid; place-items:center; font-weight:700; border-radius:12px; background: var(--chip-bg); color:#000; box-shadow:0 2px 10px rgba(0,0,0,.35); font-size: 0.9rem; }
    .list-card ul.ul-neo:not(.style-dash) > li::before { content:""; inline-size:.9rem; block-size:.9rem; border-radius:8px; background: var(--chip-bg); box-shadow:0 1px 6px rgba(0,0,0,.35); translate:0 .15rem; }

    .ascii-card { background: var(--list-bg); border-radius: calc(var(--list-radius) + 2px); border: 1px solid var(--txt-bd); margin: 1rem 0; overflow:auto; }
    .ascii-card pre { margin:0; padding:1rem 1.1rem; line-height:1.35; font-family: monospace; white-space:pre; }
    .raw-html-card { background: var(--txt-card); border: 1px dashed var(--txt-bd); border-radius: 14px; padding: .85rem 1rem; margin: .9rem 0; }
    .raw-html-card .raw-note { color: var(--text-muted); font-size:.85em; margin-bottom:.35rem; }

    /* Icons Helper */
    .svg-icon { width: 14px; height: 14px; stroke: currentColor; stroke-width: 2; fill: none; }
    
    /* Mobile Fixes */
    @media (max-width: 600px) {
        .msg-block { max-width: 90%; }
        .input-dock { padding: 10px 10px 10px 10px; }
        .input-row { gap: 6px; }
        .btn-icon { width: 38px; height: 38px; min-width: 38px; }
        .glass-input { padding: 10px 16px; font-size: 0.95rem; }
        #chat-container { padding-bottom: 90px; }
    }
  </style>
  <style id="custom-styles"></style>
</head>

<body class="field-closed mode-night">

  <svg style="display:none">
    <symbol id="icon-orb" viewBox="0 0 24 24"><circle cx="12" cy="12" r="7"/><circle cx="12" cy="12" r="8"/></symbol>
    <symbol id="icon-cards" viewBox="0 0 24 24"><rect x="2" y="2" width="16" height="16" rx="2"/><path d="M22 6v14a2 2 0 0 1-2 2H6"/></symbol>
    <symbol id="icon-gem" viewBox="0 0 24 24"><path d="M6 3h12l4 6-10 12L2 9z"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></symbol>
    <symbol id="icon-send" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></symbol>
    <symbol id="icon-copy" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d=""/></symbol>
    <symbol id="icon-voice" viewBox="0 0 24 24"><rect x="9" y="1" width="6" height="12" rx="3"/><path d="M5 10a7 7 0 0 0 14 0"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></symbol>
    <symbol id="icon-edit" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></symbol>
    <symbol id="icon-upload" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></symbol>
    <symbol id="icon-download" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></symbol>
    <symbol id="icon-sandbox" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></symbol>
    <symbol id="icon-pdf" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></symbol>
    <symbol id="icon-mic" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></symbol>
  </svg>
    
  <div class="sky-layer"><div class="sun-background"></div></div>
  <div id="particles-js"></div>
  <div id="bg-fake-custom"></div> 
  <div id="nv-toast"></div>
  <div id="modeIndicator">CARREGANDO nO.S¬∫lar...</div>

  <div class="header-orb" id="orbToggle" title="Acessar Cockpit do Usu√°rio"><svg><use href="#icon-orb"></use></svg></div>
  <div id="usernameDisplay"></div>

  <div class="top-bar">
    <div class="top-grp"><button class="btn-icon" id="btnSettings" title="Configura√ß√µes"><svg><use href="#icon-settings"></use></svg></button></div>
    <div class="top-grp"><button class="btn-icon" id="btnDeck" title="Deck"><svg><use href="#icon-cards"></use></svg></button><button class="btn-icon" id="btnCrystallize" title="Cristalizar"><svg><use href="#icon-gem"></use></svg></button></div>
  </div>

  <div id="chat-container" class="collapsed">
    <div class="msg-block system">Dual.Infodose v8.1 ¬∑ KOBLLUX OMEGA<br>Mon√≥lito Integrado & Beauty V3<br>KODUX INTEGRATED [ATLAS + V.E.E.B]</div>
  </div>

  <div class="input-dock">
    <div id="filePreview" class="file-preview"><div class="file-info"><span></span></div><div class="file-actions"></div></div>
    <input type="file" id="fileUploadInput" accept="image/*,.pdf,.txt,.json,.js,.css,.html" style="display:none;">
    <div id="field-toggle-handle"><span class="footer-dot"></span>tocar o campo √© consentir</div>
    <div class="input-row">
        <button class="btn-icon" id="btnVoice" title="Voz"><svg><use href="#icon-voice"></use></svg></button>
        <button class="btn-icon" id="btnUploadFile" title="Enviar Arquivo"><svg><use href="#icon-upload"></use></svg></button>
        <input type="text" id="userInput" class="glass-input" placeholder="Emitir pulso..." autocomplete="off">
        <button class="btn-icon btn-primary" id="btnSend" title="Enviar"><svg><use href="#icon-send"></use></svg></button>
    </div>
  </div>

  <div id="drawerSettings" class="drawer">
    <div class="drawer-content">
      <div class="drawer-header"><h3>Configura√ß√£o Neural</h3><button class="btn-icon" onclick="toggleDrawer('drawerSettings')">‚úï</button></div>
      <div class="drawer-body">
        <div class="form-group"><label>Chave Dual (API Key)</label><input type="password" id="apiKeyInput" class="glass-input" style="border-radius:8px;width:100%" placeholder="sk-or-v1-..." /></div>
        <div class="form-group"><label>Dual (Prompt)</label><textarea id="systemRoleInput" class="glass-textarea" placeholder="Voc√™ √© o Or√°culo..."></textarea></div>
        <hr style="border-color:rgba(255,255,255,0.1);margin:15px 0;">
        <div class="form-group"><label>Seu (Style)</label><input type="file" id="cssUploadInput" accept=".css,text/plain" style="margin-bottom:5px;font-size:0.8rem;"/><textarea id="customCssInput" class="glass-textarea" placeholder="Cole CSS aqui..."></textarea><button class="btn-block" id="btnClearCss" style="margin-top:5px;color:var(--danger)">Remover CSS</button></div>
        <button class="btn-block active" id="btnSaveConfig" style="margin-top:15px;background:var(--primary);color:black;">Salvar Tudo</button>
        <button class="btn-block" style="margin-top:10px;color:var(--danger);border-color:var(--danger)" onclick="if(confirm('Resetar tudo?')){localStorage.clear();location.reload();}">Factory Reset</button>
      </div>
    </div>
  </div>

  <div id="drawerProfile" class="drawer">
    <div class="drawer-content">
      <div class="drawer-header"><h3><svg style="width:20px;height:20px;margin-right:8px;stroke:var(--secondary)"><use href="#icon-orb"></use></svg> Cockpit Solar</h3><button class="btn-icon" onclick="toggleDrawer('drawerProfile')">‚úï</button></div>
      <div class="drawer-body">
        <div class="cockpit-item" style="text-align:center;margin-bottom:15px;"><div class="cockpit-label">Ciclo Solar</div><div id="statusSolarMode" style="font-size:1.2rem;font-weight:bold;margin:5px 0;">AUTO</div><div class="control-row"><button class="btn-block" id="btnCycleSolar">Manual ‚òÄÔ∏è/üåô</button><button class="btn-block" id="btnAutoSolar">Auto üïí</button></div></div>
        <div class="cockpit-grid">
            <div class="cockpit-item"><div class="cockpit-label">Identifica√ß√£o</div><input type="text" id="inputUserId" class="cockpit-input" placeholder="An√¥nimo"></div>
            <div class="cockpit-item"><div class="cockpit-label">Modelo IA</div><input type="text" id="inputModel" class="cockpit-input" placeholder="google/gemini-2.0-flash-exp"></div>
            <div class="cockpit-item"><div class="cockpit-label">Background</div><div style="display:flex;justify-content:space-between;align-items:center;"><span id="bgStatusText" style="font-size:0.8rem;color:var(--text-muted)">Nenhum</span><label class="btn-icon" style="width:30px;height:30px;border-radius:5px;"><input type="file" id="bgUploadInput" accept="image/*" style="display:none"><svg><use href="#icon-cards"></use></svg></label></div></div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="drawerDeck" class="drawer">
    <div class="drawer-content">
      <div class="drawer-header"><h3>Mem√≥rias Cristalizadas</h3><button class="btn-icon" onclick="toggleDrawer('drawerDeck')">‚úï</button></div>
      <div class="drawer-body" id="deckList"><div style="text-align:center;color:var(--text-muted);margin-top:20px">O vazio reina aqui.<br>Use o bot√£o üíé para salvar.</div></div>
    </div>
  </div>

<script>
/* =========================================================
   DUAL.INFODOSE v8.1 ‚Äî KOBLLUX OMEGA (REFACTORED)
   Integrated: Core Logic, Beauty V3, List V2, HTML View, Deck
========================================================= */

const STORAGE = { API_KEY: 'KDX_API_KEY', MODEL: 'KDX_MODEL', SYSTEM_ROLE: 'KDX_SYSTEM_ROLE', USER_ID: 'KDX_USER_ID', BG_IMAGE: 'KDX_BG_IMAGE', CUSTOM_CSS: 'KDX_CUSTOM_CSS', SOLAR_MODE: 'KDX_SOLAR_MODE', SOLAR_AUTO: 'KDX_SOLAR_AUTO' };

// KODUX UTILS
const FOOTER_TEXTS = { closed:{ritual:["tocar o campo √© consentir","registro aguarda presen√ßa"],tecnico:["lat√™ncia detectada","aguardando input"]}, open:{sustentado:["campo ativo","consci√™ncia expandida"],estavel:["sinal estabilizado","link neural firme"]}, loading:["sincronizando neuro-link...","buscando no √©ter...","decodificando sinal..."] };
function getRandomText(arr){ let t = arr[Math.floor(Math.random()*arr.length)]; return t; }

/* ===============================
   PATCH ¬∑ OPENROUTER WRAPPER
   Replaces raw fetch calls with a single helper
================================ */
window.OpenRouter = {
  endpoint: 'https://openrouter.ai/api/v1/chat/completions',
  timeout(ms, signal) { return new Promise((_, rej) => { const t = setTimeout(()=>rej(new Error('timeout')), ms); if(signal) signal.addEventListener('abort', ()=>{ clearTimeout(t); rej(new Error('aborted')) }); }); },

  async chat({ model = 'gpt-4o-mini', messages = [], apiKey } = {}) {
    apiKey = apiKey || localStorage.getItem(STORAGE.API_KEY) || '';
    if(!apiKey) throw new Error('OpenRouter: API key ausente.');

    const controller = new AbortController();
    const signal = controller.signal;
    const timeoutMs = 12000;

    try {
      const fetchPromise = fetch(this.endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`,
          'HTTP-Referer': location.origin
        },
        body: JSON.stringify({ model, messages }),
        signal
      });

      const res = await Promise.race([fetchPromise, this.timeout(timeoutMs, signal)]);
      if(!res.ok) {
        const text = await res.text().catch(()=>res.statusText);
        throw new Error(`OpenRouter Error ${res.status}: ${text}`);
      }
      const json = await res.json();
      return json;
    } catch (err) {
      if (!signal.aborted && !err._retried) {
        err._retried = true;
        console.warn('OpenRouter: retrying after error', err.message);
        await new Promise(r=>setTimeout(r, 500));
        return this.chat({ model, messages, apiKey });
      }
      throw err;
    } finally {
      try { controller.abort(); } catch(e){}
    }
  }
};

/* ===============================
   PATCH ¬∑ TTS UNIVERSAL (Toasts + Mensagens)
================================ */
window.TTS = {
  enabledKey: 'KDX_TTS_ENABLED',
  voiceKey: 'KDX_TTS_VOICE',
  rateKey: 'KDX_TTS_RATE',

  isEnabled() { return localStorage.getItem(this.enabledKey) === 'true'; },
  setEnabled(v){ localStorage.setItem(this.enabledKey, v ? 'true' : 'false'); },

  speak(text = '', { lang = 'pt-BR', rate = 1.05, force = false } = {}) {
    if(!text) return;
    if(!force && !this.isEnabled()) return;
    try {
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = lang;
      u.rate = rate;
      const voiceName = localStorage.getItem(this.voiceKey);
      if(voiceName) {
        const v = window.speechSynthesis.getVoices().find(x=>x.name===voiceName);
        if(v) u.voice = v;
      }
      window.speechSynthesis.speak(u);
    } catch(e){ console.warn('TTS error', e); }
  },

  toggle() { const n = !this.isEnabled(); this.setEnabled(n); return n; },

  initSettingsUI(containerId = 'drawerSettings') {
    const parent = document.getElementById(containerId)?.querySelector('.drawer-body');
    if(!parent) return;
    if(document.getElementById('ttsToggleRow')) return;
    const row = document.createElement('div'); row.id='ttsToggleRow'; row.className='form-group';
    row.innerHTML = `
      <label>TTS (Falar toasts & respostas)</label>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnToggleTTS" class="btn-block" style="width:120px">${this.isEnabled() ? 'TTS: ON' : 'TTS: OFF'}</button>
        <select id="ttsVoiceSelect" class="cockpit-input" style="width:calc(100% - 140px)"></select>
      </div>
    `;
    parent.prepend(row);

    const select = row.querySelector('#ttsVoiceSelect');
    function loadVoices(){
      const voices = speechSynthesis.getVoices();
      select.innerHTML = voices.map(v=>`<option value="${v.name}">${v.name} ‚Äî ${v.lang}</option>`).join('');
      const sel = localStorage.getItem(TTS.voiceKey);
      if(sel) select.value = sel;
    }
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;

    row.querySelector('#btnToggleTTS').onclick = () => {
      const on = TTS.toggle();
      row.querySelector('#btnToggleTTS').innerText = on ? 'TTS: ON' : 'TTS: OFF';
      App.showToast(on ? 'TTS ativado' : 'TTS desativado');
    };
    select.onchange = (e) => { localStorage.setItem(TTS.voiceKey, e.target.value); App.showToast('Voz selecionada'); };
  },

  integrateWithApp() {
    if(!window.App) return;
    const originalToast = App.showToast ? App.showToast.bind(App) : (m=>console.log('toast',m));
    App.showToast = function(msg){
      originalToast(msg);
      TTS.speak(String(msg));
    };
    const originalSpeak = App.speakText ? App.speakText.bind(App) : ()=>{};
    App.speakText = function(text, force=false){
      TTS.speak(text, { force });
      try { originalSpeak(text); } catch(e){}
    };
    this.initSettingsUI();
  }
};

/* ===============================
   PATCH ¬∑ SANDBOX TOTAL
================================ */
window.Sandbox = {
  defaultAttrs() {
    return [
      'allow-scripts',
      'allow-forms',
      'allow-modals',
      'allow-popups',
      'allow-same-origin'
    ].join(' ');
  },

  open(htmlString, { sandboxAttr = null, newWindow = false, title = 'sandbox', width = 1000, height = 700 } = {}) {
    sandboxAttr = sandboxAttr || this.defaultAttrs();
    const blob = new Blob([htmlString], { type: 'text/html' });
    const url = URL.createObjectURL(blob);

    if(newWindow) {
      const w = window.open('', '_blank', `noopener,noreferrer,title=${title},width=${width},height=${height}`);
      if(!w) return alert('Bloqueador de popups impediu a abertura.');
      w.document.write(`<iframe src="${url}" sandbox="${sandboxAttr}" style="width:100vw;height:100vh;border:none"></iframe>`);
      w.document.title = title;
      return w;
    } else {
      const id = 'sandbox-' + Date.now();
      const container = document.createElement('div');
      container.id = id;
      container.className = 'drawer open';
      container.style.zIndex = 99999;
      container.innerHTML = `<div class="drawer-content" style="width:95%;max-width:calc(${width}px);height:calc(${height}px);"><div class="drawer-header"><h3>${title}</h3><button class="btn-icon" id="${id}-close">‚úï</button></div><div style="flex:1;padding:0;display:flex;"><iframe src="${url}" sandbox="${sandboxAttr}" style="width:100%;height:100%;border:none;background:white;"></iframe></div></div>`;
      document.body.appendChild(container);
      document.getElementById(`${id}-close`).onclick = ()=>{ container.remove(); URL.revokeObjectURL(url); };
      return container;
    }
  }
};

/* ---------------------------------------------------------
   UTILS & DOWNLOAD HELPER
   --------------------------------------------------------- */
const Utils = {
    copy(btn) { const t=btn.closest('.msg-block').innerText.replace("content_copy","").trim(); navigator.clipboard.writeText(t); App.showToast("Copiado"); },
    speak(btn) { App.speakText(btn.closest('.msg-block').innerText.replace(/<[^>]*>?/gm, '').trim()); },
    edit(btn) { const b = btn.closest('.msg-block'); document.getElementById('userInput').value = b.innerText.replace("content_copy","").trim(); b.remove(); App.speakText("Editando"); }
};

const DownloadUtils = {
    _getBlock(btn) { return btn.closest('.msg-block'); },
    _getCleanHtml(block) { const clone = block.cloneNode(true); clone.querySelectorAll('.msg-tools, .copy-code-btn').forEach(e => e.remove()); return clone.innerHTML; },
    _guessFilename(ext='txt') { const t = new Date().toISOString().replace(/[:.]/g,'-'); return `dual-output-${t}.${ext}`; },
    downloadMessage(btn) { const block=this._getBlock(btn); const content=this._getCleanHtml(block); const blob=new Blob([content],{type:'text/html;charset=utf-8'}); this.triggerDownload(blob, this._guessFilename('html')); },
    openSandbox(btn) { const block=this._getBlock(btn); const content=this._getCleanHtml(block); const blob=new Blob([content],{type:'text/html'}); window.open(URL.createObjectURL(blob), '_blank'); },
    async exportPdf(btn) { 
        if(typeof html2pdf==='undefined') return this.openSandbox(btn); 
        const block=this._getBlock(btn); const content=this._getCleanHtml(block); 
        const div=document.createElement('div'); div.innerHTML=content; 
        div.style.cssText = 'background:white; color:black; padding:20px; font-family:sans-serif; width:100%;';
        const opt = { margin: 10, filename: this._guessFilename('pdf'), image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(div).save(); 
    },
    triggerDownload(blob, filename) { const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }
};

/* ---------------------------------------------------------
   PREVIEW & HTML VIEWER
   --------------------------------------------------------- */
const Preview = {
    async renderPreview(file) {
        if(file.type==='text/html'||file.name.endsWith('.html')){ const t=await file.text(); const b=new Blob([t],{type:'text/html'}); return `<div class="preview-html"><iframe src="${URL.createObjectURL(b)}" style="width:100%;height:300px;border:none;background:white;"></iframe></div>`; }
        if(file.type.startsWith('image/')) return `<img src="${URL.createObjectURL(file)}" style="max-width:100%;border-radius:8px;margin-top:5px;">`;
        const t=await file.text(); return `<pre><code>${t.slice(0,500).replace(/</g,'&lt;')}</code></pre>`;
    },
    createHtmlViewer(htmlCode) {
        const id='html-'+Date.now(); const url=URL.createObjectURL(new Blob([htmlCode],{type:'text/html'}));
        return `<div class="html-viewer" id="${id}"><div class="html-viewer-bar"><button class="html-viewer-btn active" onclick="Preview.switch('${id}','p')">Preview</button><button class="html-viewer-btn" onclick="Preview.switch('${id}','c')">Code</button><button class="html-viewer-btn" onclick="Preview.full('${id}','${url}')">Full</button></div><div class="html-viewer-content"><iframe src="${url}" sandbox="allow-scripts allow-popups allow-forms"></iframe><div class="html-viewer-code"><pre><code>${htmlCode.replace(/</g,'&lt;')}</code></pre></div></div></div>`;
    },
    switch(id,m){ const c=document.getElementById(id); if(m==='c')c.classList.add('show-code'); else c.classList.remove('show-code'); },
    full(id,url){ const c=document.getElementById(id); c.classList.add('fullscreen'); c.querySelector('iframe').src=url; const btn=document.createElement('button'); btn.innerText='Exit'; btn.style.cssText='position:fixed;top:10px;right:10px;z-index:10000;padding:10px;background:red;color:white;border:none;border-radius:5px;cursor:pointer;'; btn.onclick=()=>{c.classList.remove('fullscreen'); btn.remove();}; document.body.appendChild(btn); }
};

/* ---------------------------------------------------------
   BEAUTY PATCH V3 LOGIC
   --------------------------------------------------------- */
const BeautyPatch = {
    esc(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); },
    run(root){
        const $$=(s)=>Array.from(root.querySelectorAll(s));
        
        // 1. Chips & Inline
        $$('p, li, h1, h2, h3').filter(n=>!n.closest('pre, code, .no-beauty')).forEach(el=>{
            if(el.dataset.beauty) return; el.dataset.beauty='1';
            let h = el.innerHTML;
            if(/<pre|<code|contenteditable/.test(h)) return;
            h = h.replace(/(^|\s)([A-Za-z√Ä-√ø0-9_]+):(?=\s|$)/g, (m,sp,k)=>`${sp}<strong class="kv-key">${k}:</strong>`)
                 .replace(/\(([^\n)]+)\)/g, (m,i)=>`<span class="span-paren">(${i})</span>`)
                 .replace(/\[\[([^[\]]+)\]\]|\[([^[\]]+)\]/g, (m,d,s)=>{ const t=(d||s).trim(); return `<span class="${d?'chip-btn':'chip'}">${this.esc(t)}</span>`; });
            el.innerHTML = h;
        });

        // 2. Questions
        $$('p').forEach(p=>{
           const t = p.innerText.trim();
           if(t.endsWith('?') && t.length < 150 && !p.closest('.q-card')){
               const d=document.createElement('div'); d.className='q-card';
               d.innerHTML=`<div class="q-ico">?</div><div class="q-body">${this.esc(t)}</div>`;
               p.replaceWith(d);
           } 
        });

        // 3. Lists
        $$('ul, ol').forEach(list=>{
            if(list.closest('.list-card')) return;
            const w=document.createElement('div'); w.className='list-card';
            const isOl=list.tagName==='OL';
            list.classList.add(isOl?'ol-neo':'ul-neo');
            list.parentNode.insertBefore(w, list); w.appendChild(list);
            const b=document.createElement('div'); b.className='copy-badge'; b.textContent='copiar';
            b.onclick=()=>{ navigator.clipboard.writeText(list.innerText); b.textContent='ok!'; setTimeout(()=>b.textContent='copiar',1000); };
            w.appendChild(b);
        });

        // 4. Raw HTML
        $$('pre code.language-html-raw').forEach(c=>{
            const raw=c.textContent; const p=c.closest('pre');
            const d=document.createElement('div'); d.className='raw-html-card';
            d.innerHTML=`<div class="raw-note">Render Visual</div><div style="padding:10px;background:white;color:black;border-radius:5px">${raw}</div>`;
            p.replaceWith(d);
        });
    }
};

/* ---------------------------------------------------------
   MAIN APP CONTROLLER
   --------------------------------------------------------- */
const App = {
    state: { open: false, messages: [], isAutoSolar: true, solarMode: 'night', isProcessing: false, isListening: false, recognition: null },
    
    init() {
        const s = localStorage;
        // Load Configs
        document.getElementById('apiKeyInput').value = s.getItem(STORAGE.API_KEY) || '';
        document.getElementById('inputUserId').value = s.getItem(STORAGE.USER_ID) || 'Viajante';
        document.getElementById('inputModel').value = s.getItem(STORAGE.MODEL) || 'google/gemini-2.0-flash-exp';
        
        // System Prompt Default
        const defaultRole = `(K√òBLLUX ¬∑ DUŒõL ¬∑ M√òD√ò UN√ò)\nVoc√™ √© Dual.Infodose v8.1. Regras Visuais: 1) Use Markdown rico. 2) Destaque termos chave entre [colchetes] para criar chips. 3) Listas devem ser estruturadas. 4) Se gerar HTML completo, avise. 5) Seja m√≠stico mas pr√°tico.`;
        document.getElementById('systemRoleInput').value = s.getItem(STORAGE.SYSTEM_ROLE) || defaultRole;

        // Solar Mode
        this.state.isAutoSolar = s.getItem(STORAGE.SOLAR_AUTO) !== 'false';
        if (this.state.isAutoSolar) this.autoByTime(); else this.setMode(s.getItem(STORAGE.SOLAR_MODE) || 'night');

        // Assets
        this.indexedDB.loadCustomCSS();
        this.indexedDB.loadBackground();
        this.setupVoiceSystem();
        this.bindEvents();
        this.updateUI();
        this.renderDeck();

        // Particles Init
        if(typeof particlesJS !== 'undefined') {
            particlesJS('particles-js', {particles:{number:{value:30},color:{value:"#ffffff"},opacity:{value:0.5},size:{value:2},line_linked:{enable:true,distance:150,color:"#ffffff",opacity:0.2,width:1}}});
        }
        
        setTimeout(() => this.showToast("Dual.Infodose Online"), 1000);
    },

    setupVoiceSystem() {
        if (!('webkitSpeechRecognition' in window)) return;
        try {
            this.state.recognition = new webkitSpeechRecognition();
            this.state.recognition.lang = 'pt-BR'; 
            this.state.recognition.continuous = false; 
            this.state.recognition.interimResults = false;
            
            this.state.recognition.onstart = () => { this.state.isListening = true; document.getElementById('btnVoice').classList.add('listening'); this.showToast("üéôÔ∏è Ouvindo..."); };
            this.state.recognition.onend = () => { this.state.isListening = false; document.getElementById('btnVoice').classList.remove('listening'); };
            this.state.recognition.onresult = (e) => { 
                const t = e.results[0][0].transcript; 
                document.getElementById('userInput').value = t; 
                setTimeout(()=>this.handleSend(), 500);
            };
        } catch(e) { console.warn("Voice API error", e); }
    },
    toggleVoice() { 
        if (!this.state.recognition) return alert("Navegador sem suporte a voz."); 
        if (this.state.isListening) this.state.recognition.stop(); else this.state.recognition.start(); 
    },

    async handleSend() {
        const input = document.getElementById('userInput'); const txt = input.value.trim();
        if (!txt || this.state.isProcessing) return;
        input.value = ''; this.addMessage('user', txt);
        
        // UI State
        this.state.isProcessing = true; 
        document.getElementById('field-toggle-handle').innerHTML = `<span class="footer-dot pulse"></span> ${getRandomText(FOOTER_TEXTS.loading)}`;
        document.body.style.cursor = 'wait';
        
        try {
            const history = this.state.messages.slice(-8).map(m=>({role:m.role,content:m.content}));
            const sys = {role:'system', content:document.getElementById('systemRoleInput').value};
            
            // ===== REPLACED: use OpenRouter wrapper for reliability =====
            const model = document.getElementById('inputModel').value;
            const payloadMessages = [ sys, ...history, {role:'user',content:txt} ];
            const data = await OpenRouter.chat({ model, messages: payloadMessages });
            const aiContent = data.choices?.[0]?.message?.content || "Sem sinal do or√°culo.";
            // ==========================================================

            // HTML Detection
            if (/^\s*(<!doctype html|<html)/i.test(aiContent)) {
                this.addHTMLViewer(aiContent);
                this.addMessage('ai', "Renderizei o artefato visual acima.");
            } else {
                this.addMessage('ai', aiContent);
            }
        } catch (e) { 
            this.addMessage('system', `Erro na transmiss√£o: ${e.message}`); 
        } finally { 
            document.body.style.cursor = 'default';
            this.state.isProcessing = false; 
            this.toggleField(true, true); 
        }
    },

    addMessage(role, text) {
        const c = document.getElementById('chat-container');
        const d = document.createElement('div'); d.className = `msg-block ${role}`;
        
        let content = text;
        if(role === 'ai') {
            content = marked.parse(text);
        } else if (role === 'user') {
            content = text.replace(/\n/g, '<br>');
        }

        if(role !== 'system') {
            const tools = `
            <div class="msg-tools">
                <button class="tool-btn" onclick="Utils.copy(this)" title="Copiar"><svg><use href="#icon-copy"></use></svg></button>
                <button class="tool-btn" onclick="Utils.speak(this)" title="Ler"><svg><use href="#icon-mic"></use></svg></button>
                ${role === 'ai' ? `
                <button class="tool-btn" onclick="DownloadUtils.downloadMessage(this)" title="Baixar HTML"><svg><use href="#icon-download"></use></svg></button>
                <button class="tool-btn" onclick="DownloadUtils.exportPdf(this)" title="PDF"><svg><use href="#icon-pdf"></use></svg></button>
                ` : `
                <button class="tool-btn" onclick="Utils.edit(this)" title="Editar"><svg><use href="#icon-edit"></use></svg></button>
                `}
            </div>`;
            content += tools;
            this.state.messages.push({ role: role==='ai'?'assistant':'user', content: text });
        }
        
        d.innerHTML = content;
        
        // Apply Syntax Highlight
        d.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
        // Add Copy Button to Code Blocks
        d.querySelectorAll('pre').forEach(pre => { 
            const b=document.createElement('button'); b.className='copy-code-btn'; b.textContent='Copiar'; 
            b.onclick=()=>{navigator.clipboard.writeText(pre.innerText); b.textContent='Copiado!'; setTimeout(()=>b.textContent='Copiar',1500);}; 
            pre.appendChild(b); 
        });

        c.appendChild(d);
        // Run Beauty Patch on new message
        BeautyPatch.run(d);
        
        // Scroll
        setTimeout(()=>c.scrollTop = c.scrollHeight, 100);
    },
    
    addHTMLViewer(htmlContent) {
        const c = document.getElementById('chat-container'); 
        const d = document.createElement('div'); d.className = `msg-block ai`;
        d.innerHTML = `<div><strong>Artefato Gerado:</strong></div>${Preview.createHtmlViewer(htmlContent)}`;
        c.appendChild(d);
    },

    speakText(text) { 
        if(!text) return; 
        window.speechSynthesis.cancel(); 
        const u = new SpeechSynthesisUtterance(text); 
        u.lang='pt-BR'; u.rate=1.2; 
        window.speechSynthesis.speak(u); 
    },
    
    showToast(msg) { 
        const t = document.getElementById('nv-toast'); 
        t.textContent=msg; t.classList.add('show'); 
        setTimeout(()=>t.classList.remove('show'),3000); 
    },

    setMode(m) { this.state.solarMode=m; document.body.className = `field-closed mode-${m}`; this.updateUI(); localStorage.setItem(STORAGE.SOLAR_MODE, m); },
    cycleSolar() { const n = this.state.solarMode==='day'?'sunset':(this.state.solarMode==='sunset'?'night':'day'); this.state.isAutoSolar=false; this.setMode(n); },
    autoByTime() { const h=new Date().getHours(); this.setMode((h>=6&&h<17)?'day':(h>=17&&h<19)?'sunset':'night'); },
    
    updateUI() { 
        document.getElementById('statusSolarMode').textContent = `${this.state.solarMode.toUpperCase()} ${this.state.isAutoSolar?'(AUTO)':''}`; 
        document.getElementById('modeIndicator').textContent = `SISTEMA: ${this.state.solarMode}`;
        document.getElementById('usernameDisplay').textContent = document.getElementById('inputUserId').value; 
    },
    
    toggleField(forceState, skipSpeak) { 
        this.state.open = forceState!==undefined ? forceState : !this.state.open; 
        document.getElementById('chat-container').classList.toggle('collapsed', !this.state.open); 
        
        const txt = getRandomText(FOOTER_TEXTS[this.state.open?'open':'closed']['ritual']);
        document.getElementById('field-toggle-handle').innerHTML = `<span class="footer-dot"></span> ${txt}`;
        if(!skipSpeak) this.speakText(txt);
    },
    
    // DECK (MEMORY)
    async crystallizeSession() {
        if(this.state.messages.length === 0) return this.showToast("Nada para cristalizar.");
        const title = this.state.messages.find(m => m.role === 'user')?.content.substring(0, 30) || "Mem√≥ria";
        await this.indexedDB.saveDeckItem({ id: Date.now(), date: new Date().toLocaleString(), title: title + "...", data: [...this.state.messages] });
        await this.renderDeck(); this.showToast("Mem√≥ria Cristalizada.");
    },
    async renderDeck() {
        const items = await this.indexedDB.getDeck(); const c = document.getElementById('deckList');
        if(!items || items.length === 0) { c.innerHTML = '<div style="text-align:center;opacity:0.5;margin-top:20px">Vazio</div>'; return; }
        c.innerHTML = items.sort((a,b)=>b.id-a.id).map(i => `<div class="deck-item"><div class="deck-info" onclick="App.restoreMemory(${i.id})"><h4>${i.title}</h4><span>${i.date}</span></div><button class="tool-btn" onclick="App.deleteMemory(${i.id})"><svg><use href="#icon-trash"></use></svg></button></div>`).join('');
    },
    async restoreMemory(id) { const items = await this.indexedDB.getDeck(); const i = items.find(x=>x.id===id); if(i){ document.getElementById('chat-container').innerHTML=''; this.state.messages=[]; i.data.forEach(m=>this.addMessage(m.role==='assistant'?'ai':'user',m.content)); toggleDrawer('drawerDeck'); } },
    async deleteMemory(id) { if(confirm("Apagar mem√≥ria?")) { await this.indexedDB.deleteDeckItem(id); this.renderDeck(); } },

    bindEvents() {
        const el = (id) => document.getElementById(id);
        el('btnSend').onclick=()=>this.handleSend();
        el('userInput').onkeypress=(e)=>{if(e.key==='Enter')this.handleSend()};
        el('field-toggle-handle').onclick=()=>this.toggleField();
        el('orbToggle').onclick=()=>{toggleDrawer('drawerProfile');};
        el('btnCrystallize').onclick = () => this.crystallizeSession();
        el('btnCycleSolar').onclick = () => this.cycleSolar();
        el('btnAutoSolar').onclick = () => {this.state.isAutoSolar=true;this.autoByTime();};
        el('inputUserId').onchange=(e)=>{localStorage.setItem(STORAGE.USER_ID,e.target.value);this.updateUI();};
        el('btnSaveConfig').onclick=()=>{
            localStorage.setItem(STORAGE.API_KEY, el('apiKeyInput').value);
            localStorage.setItem(STORAGE.SYSTEM_ROLE, el('systemRoleInput').value);
            localStorage.setItem(STORAGE.MODEL, el('inputModel').value);
            this.indexedDB.saveCustomCSS(el('customCssInput').value);
            toggleDrawer('drawerSettings'); this.showToast("Configura√ß√µes Salvas");
        };
        el('bgUploadInput').onchange=(e)=>this.indexedDB.handleBackgroundUpload(e.target.files[0]);
        el('btnSettings').onclick=()=>toggleDrawer('drawerSettings');
        el('btnDeck').onclick=()=>{ toggleDrawer('drawerDeck'); this.renderDeck(); };
        el('btnClearCss').onclick=()=>this.indexedDB.clearAsset(STORAGE.CUSTOM_CSS);
        el('btnVoice').onclick=()=>this.toggleVoice();
        el('btnUploadFile').onclick=()=>el('fileUploadInput').click();
        
        el('fileUploadInput').onchange=async(e)=>{
             const f=e.target.files[0]; if(!f)return;
             const p=el('filePreview'); p.classList.add('active'); p.querySelector('span').textContent=f.name;
             p.querySelector('.file-actions').innerHTML=`<button class="btn-preview primary" onclick="App.confirmUpload('${f.name}')">Enviar</button><button class="btn-preview" onclick="document.getElementById('filePreview').classList.remove('active')">X</button>`;
        };
    },
    confirmUpload(n){
        const f=document.getElementById('fileUploadInput').files[0];
        const r=new FileReader(); r.onload=async(e)=>{
            const c=e.target.result; const prev=await Preview.renderPreview(f);
            this.addMessage('ai', `<div class="file-header">Arquivo Recebido: ${n}</div>${prev}`);
            this.state.messages.push({role:'user',content:`[CONTEXTO: O usu√°rio enviou o arquivo "${n}"]\nCONTE√öDO:\n${c}\n---\nAnalise este arquivo.`});
            document.getElementById('filePreview').classList.remove('active');
            this.handleSend(); // Auto trigger analysis
        }; 
        if(f.type.startsWith('image')) r.readAsDataURL(f); else r.readAsText(f);
    },

    indexedDB: {
        async getDB() { return new Promise((r,j)=>{const q=indexedDB.open("InfodoseDB",2);q.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('assets'))d.createObjectStore('assets',{keyPath:'id'});if(!d.objectStoreNames.contains('deck'))d.createObjectStore('deck',{keyPath:'id'});};q.onsuccess=e=>r(e.target.result);q.onerror=j;}); },
        async putAsset(i,d){(await this.getDB()).transaction(['assets'],'readwrite').objectStore('assets').put({id:i,...d});},
        async getAsset(i){return new Promise(async r=>(await this.getDB()).transaction(['assets']).objectStore('assets').get(i).onsuccess=e=>r(e.target.result));},
        async clearAsset(i){(await this.getDB()).transaction(['assets'],'readwrite').objectStore('assets').delete(i); if(i===STORAGE.CUSTOM_CSS)document.getElementById('custom-styles').textContent='';},
        async handleBackgroundUpload(f){if(!f)return;await this.putAsset(STORAGE.BG_IMAGE,{blob:f});this.loadBackground();},
        async loadBackground(){const d=await this.getAsset(STORAGE.BG_IMAGE);if(d?.blob)document.getElementById('bg-fake-custom').style.backgroundImage=`url('${URL.createObjectURL(d.blob)}')`;},
        async saveCustomCSS(c){await this.putAsset(STORAGE.CUSTOM_CSS,{css:c});this.loadCustomCSS();},
        async loadCustomCSS(){const d=await this.getAsset(STORAGE.CUSTOM_CSS);if(d?.css){document.getElementById('custom-styles').textContent=d.css;document.getElementById('customCssInput').value=d.css;}},
        async saveDeckItem(i){(await this.getDB()).transaction(['deck'],'readwrite').objectStore('deck').put(i);},
        async getDeck(){return new Promise(async r=>(await this.getDB()).transaction(['deck']).objectStore('deck').getAll().onsuccess=e=>r(e.target.result));},
        async deleteDeckItem(i){(await this.getDB()).transaction(['deck'],'readwrite').objectStore('deck').delete(i);}
    }
};

function toggleDrawer(id) { document.getElementById(id).classList.toggle('open'); }

// Integrate TTS with App now that App exists
if(window.TTS && typeof TTS.integrateWithApp === 'function') {
  // Wait a tick to ensure App methods available
  setTimeout(()=>{ try{ TTS.integrateWithApp(); }catch(e){console.warn('TTS integrate fail',e)} }, 300);
}

window.onload = () => App.init();
</script>
</body>
</html>